# RLS SOP Addendum (2025-10-30)

Purpose: Eliminate recurring RLS breakages by standardizing policies, audits, and deploy checks.

## 1) Golden Rules
- Server functions that perform system writes MUST use SUPABASE_SERVICE_ROLE_KEY.
- Telemetry tables (analytics/attribution) allow public INSERT, owner SELECT, admin DELETE.
- User-owned tables use WITH CHECK ownership on INSERT and owner SELECT.
- Business-owner visibility comes via providers.owner_user_id = auth.uid().
- Admin visibility uses is_admin_user(auth.uid()).

## 2) Run These on Every Deploy (Production & Preview)
- Apply standard policies:
  - Run STANDARD_RLS_POLICIES-2025-10-30.sql
  - Run any table-specific fixes (e.g., fix-coupon-redemptions-rls.sql)
- Audit active policies:
```sql
SELECT schemaname, tablename, policyname, cmd, qual, with_check
FROM pg_policies
WHERE tablename IN (
  'listing_analytics','funnel_attribution','booking_attribution',
  'booking_events','coupon_redemptions'
)
ORDER BY tablename, policyname;
```
- Verify critical functions use service role (grep your code):
  - Netlify functions: look for `createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY)`
  - Fail deploy if anon key is used for system writes

## 3) Environment Variables (Prod & Preview)
- SUPABASE_URL
- SUPABASE_ANON_KEY
- SUPABASE_SERVICE_ROLE_KEY (server functions only)
- SITE_URL (match canonical, include www)

## 4) Common Failure Modes & Fixes
- 403 on user insert: Missing WITH CHECK ownership policy.
- 403 on business owner read: Missing providers.owner_user_id = auth.uid() policy.
- 500 from server function on insert: Function used anon key, or table lacks service_role policy.
- Duplicate analytics: fix client logic, add DB constraint.

## 5) Table Policy Templates
- See STANDARD_RLS_POLICIES-2025-10-30.sql for idempotent definitions.

## 6) Rollback
- If audit deviates, re-run STANDARD_RLS_POLICIES-2025-10-30.sql.
- If still broken: run DIAGNOSE-RLS-POLICIES.sql, then align policies to templates.

## 7) CI Gate (Optional but Recommended)
- Add a deploy step that runs the audit query and compares against expected counts.
- Fail deploy if required policies are missing.
